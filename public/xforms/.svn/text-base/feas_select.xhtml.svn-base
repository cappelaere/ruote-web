<!DOCTYPE
  html PUBLIC "-//W3C//DTD XHTML 1.0//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
  
<html xmlns="http://www.w3.org/1999/xhtml" 
    xmlns:xforms="http://www.w3.org/2002/xforms" 
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"  
    xmlns:ev="http://www.w3.org/2001/xml-events" 
    xmlns:sps="http://www.opengis.net/sps" 
    xmlns:g='http://geopbms/1.0'
    xmlns:v="urn:schemas-microsoft-com:vml"
    xml:lang="en">
  
  <head>
    <title>Theme-based Request Moz XForm</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
 
    <link rel="stylesheet" type="text/css" href="/xforms/xforms.css"/>
    
 	<script type="text/javascript">
			
	// called when html is inited
	function set_location(longitude, latitude) {
		latlongchanged()
	}
	
	// force change in iframe
	function latlongchanged() {
	  var model = document.getElementById("my-model");
	  var instance = model.getInstanceDocument("my-instance");
	  var latElement = instance.getElementsByTagName("latitude")[0];
	  var latitude = latElement.firstChild.nodeValue
	   		
	  var longElement = instance.getElementsByTagName("longitude")[0];
	  var longitude = longElement.firstChild.nodeValue
	   		
	  //alert( "Lat: "+latitude+ " Long:"+longitude );
	   		
	  window.frames.map.changeMarker(latitude, longitude);
		// and can't move it anymore
	  window.frames.map.do_not_move();
	}
	
	</script>
       
    <xforms:model id='my-model' >
      <xforms:instance id='my-instance'>
      	<data xmlns=""> 	    
	         
	         <workitem>
 	         <%= @workitem_str %>
 	         </workitem>
 	         
 	         <entry>
 	         	<g:command>proceed</g:command>
 	         </entry>
             
             <results>
    	         <latitude></latitude>
	             <longitude></longitude>
	             <daynight>day</daynight>
	             <theme>fire</theme>
	             <doy></doy>
                 <path></path>
                 <row></row>
                 <date></date>
                 <instrument>hyperion</instrument>
                 <classifier>thermal</classifier>
                 <priority>medium</priority>
                 <cost></cost>
                 <comments></comments>
	          </results>
		</data>
	  </xforms:instance>
     
	 <xforms:submission id="getTheme" method="post" action="/test/index" />
	 <xforms:submission id="cancel" method="put" action="/wfcs/processes/<%= @pid %>" />
	 
	</xforms:model>
  </head>
  
  <body>
  
  <div id="geobpms-logo">
   <img src="/images/geobpms.jpg" width='70'/>
  </div>
  
  <h2>Task Requested:</h2>

  <iframe id="map" src="/xforms/gmap.html" type="text/html" width="516px" height="316px"></iframe>    
  
  
  <h2>Step 1: Select Feasibility</h2>
  			
  <table>
        <thead>
            <th width='80'>Day</th>
            <th width='200'>UTC Time</th>
            <th width='80'>SZA</th>
            <th width='80'>Pointing</th>
            <th width='80'>Cost</th>
            <th width='80'>Feasibility</th>
        </thead>
   </table>
 
      <table repeat_nodeset="workitem">
          <xforms:repeat nodeset="//sps:Feasibility" id='r2'>
          <tr>
            <td width='80'><xforms:output ref="DOY" /> </td>
            <td width='200'><xforms:output ref='UTC' /> </td>
            <td width='80' align='center'><xforms:output ref='SZA' /> </td>
            <td width='80'><xforms:output ref='TYPE' /> </td>
            <td width='80'><xforms:output ref='COST' /> </td>
            <td width='80'>
 			  <xforms:trigger>
                <xforms:label>Select</xforms:label>
                 <xforms:setvalue ev:event="DOMActivate" ref="/data/results/doy" value="//sps:Feasibility[index('r2')]/DOY" />
                 <xforms:setvalue ev:event="DOMActivate" ref="/data/results/path" value="//sps:Feasibility[index('r2')]/PATH" />
                 <xforms:setvalue ev:event="DOMActivate" ref="/data/results/row" value="//sps:Feasibility[index('r2')]/ROW" />
                 <xforms:setvalue ev:event="DOMActivate" ref="/data/results/date" value="//sps:Feasibility[index('r2')]/UTC" />
                 <xforms:setvalue ev:event="DOMActivate" ref="/data/results/cost" value="//sps:Feasibility[index('r2')]/COST" />
                 <xforms:setvalue ev:event="DOMActivate" ref="/data/results/latitude" value="/data/workitem/attributes/latitude" />
                 <xforms:setvalue ev:event="DOMActivate" ref="/data/results/longitude" value="/data/workitem/attributes/longitude" />
              </xforms:trigger>
			</td>
           </tr>
         </xforms:repeat> 	
	   </table>		
       <h2>Selected Feasibility</h2>
       <table>
       <tr><td>
	       <tr><td><b>Satellite:</b></td><td>EO1</td></tr>
	       <tr><td><b>Latitude:</b></td><td id='latitude'><xforms:output ref='/data/workitem/attributes/latitude' /></td></tr>
	       <tr><td><b>Longitude:</b></td><td id='longitude'><xforms:output ref='/data/workitem/attributes/longitude' /></td></tr>
	       <tr><td><b>Day/Night:</b></td><td><xforms:output ref='/data/workitem/attributes/daynight' /></td></tr>
	       <tr><td><b>Themes:</b></td><td><xforms:output ref='/data/workitem/attributes/theme' /></td></tr>
	       <tr><td><b>Day of Year:</b></td><td><xforms:output ref='/data/results/doy' /></td></tr>
	       <tr><td><b>Path:</b></td><td><xforms:output ref='/data/results/path' /></td></tr>
	       <tr><td><b>Row:</b></td><td><xforms:output ref='/data/results/row' /></td></tr>
	       <tr><td><b>Date:</b></td><td width='200'><xforms:output ref='/data/results/date' /></td></tr>
	       <tr><td><b>Cost:</b></td><td><xforms:output ref='/data/results/cost' /></td></tr>
	       <tr><td><b>Command:</b></td><td><xforms:output ref='/data/entry/g:command' /></td></tr>
       </td>
         <td>
           <div id="map_canvas" style="width: 500px; height: 300px"></div>
         </td>
       </tr>
       </table>
       <h2>Step 2: Additional Selections:</h2>
       <table>
       <tr><td></td>
        <td>
        <xforms:select1 ref="/data/results/instrument" appearance="full">
           <xforms:label>Instrument</xforms:label>
           <xforms:item>
			  <xforms:label>hyperion</xforms:label>
			  <xforms:value>hyperion</xforms:value>
		    </xforms:item>
			
			<xforms:item>
			  <xforms:label>ali</xforms:label>
			  <xforms:value>ali</xforms:value>
		    </xforms:item>
		</xforms:select1></td></tr>
		
		<tr><td></td>
        <td>
        <xforms:select1 ref="/data/results/classifier" appearance="full">
           <xforms:label>Classifier</xforms:label>
		    <xforms:item>
			<xforms:label>thermal</xforms:label>
			<xforms:value>thermal</xforms:value>
			</xforms:item>
		</xforms:select1>
		</td></tr>
		
	   <tr><td></td>
        <td>
        <xforms:select1 ref="/data/results/priority" appearance="full">
          <xforms:label>Priority</xforms:label>
 		 <xforms:item>
			<xforms:label>medium</xforms:label>
			<xforms:value>medium</xforms:value>
		 </xforms:item>
		 <xforms:item>
			<xforms:label>high</xforms:label>
			<xforms:value>high</xforms:value>
		 </xforms:item>	
		 <xforms:item>
			<xforms:label>vip</xforms:label>
			<xforms:value>vip</xforms:value>
		 </xforms:item>		
		</xforms:select1></td></tr>
       
       <tr><td></td>
        <td>
        <xforms:textarea ref='/data/results/comments'>
            <xforms:label>Comments:</xforms:label>
        </xforms:textarea>
        </td>
        </tr>
       </table>
       
	  <h2>Step 3: Submit</h2>
      <xforms:switch>
         <xforms:case id="submit">
          <xforms:trigger>
            <xforms:label>Submit Task Request</xforms:label>
            <xforms:action ev:event="DOMActivate">
                <xforms:toggle case="confirm"/>
             </xforms:action>
           </xforms:trigger>      
          
           <xforms:submit submission="cancel">
             <xforms:setvalue ev:event="DOMActivate" ref="entry/g:command">kill</xforms:setvalue>
             <xforms:label>Cancel Task Request?</xforms:label>
           </xforms:submit>
           
         </xforms:case>
         
         <xforms:case id="confirm">
           <xforms:submit submission="getTheme">
             <xforms:label>Confirm Submit Request?</xforms:label>
           </xforms:submit>
         </xforms:case>
       </xforms:switch>
       
  </body>
 </html>